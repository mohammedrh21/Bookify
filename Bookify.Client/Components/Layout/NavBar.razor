@inject IAuthService AuthService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<nav class="bg-white shadow-sm border-b border-gray-100 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">

            <!-- Logo -->
            <a href="/" class="flex items-center gap-2 group">
                <div class="w-9 h-9 bg-primary-600 rounded-xl flex items-center justify-center shadow-sm group-hover:bg-primary-700 transition-colors">
                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <span class="text-xl font-bold text-gray-900">Bookify</span>
            </a>

            <!-- Desktop Nav Links -->
            <div class="hidden md:flex items-center gap-6">
                <NavLink href="/" Match="NavLinkMatch.All"
                         class="text-gray-600 hover:text-primary-600 font-medium text-sm transition-colors"
                         ActiveClass="text-primary-600 font-semibold">
                    Home
                </NavLink>

                <NavLink href="/services"
                         class="text-gray-600 hover:text-primary-600 font-medium text-sm transition-colors"
                         ActiveClass="text-primary-600 font-semibold">
                    Services
                </NavLink>

                <NavLink href="/about"
                         class="text-gray-600 hover:text-primary-600 font-medium text-sm transition-colors"
                         ActiveClass="text-primary-600 font-semibold">
                    About
                </NavLink>

                <NavLink href="/contact-us"
                         class="text-gray-600 hover:text-primary-600 font-medium text-sm transition-colors"
                         ActiveClass="text-primary-600 font-semibold">
                    Contact Us
                </NavLink>

                <NavLink href="/faq"
                         class="text-gray-600 hover:text-primary-600 font-medium text-sm transition-colors"
                         ActiveClass="text-primary-600 font-semibold">
                    FAQs
                </NavLink>

                <AuthorizeView>
                    <Authorized Context="authUser">

                        <NavLink href="/my-bookings"
                                 class="text-gray-600 hover:text-primary-600 font-medium text-sm transition-colors"
                                 ActiveClass="text-primary-600 font-semibold">
                            My Bookings
                        </NavLink>

                        <AuthorizeView Roles="Admin">
                            <Authorized Context="adminUser">
                                <NavLink href="/admin/dashboard"
                                         class="text-gray-600 hover:text-primary-600 font-medium text-sm transition-colors"
                                         ActiveClass="text-primary-600 font-semibold">
                                    Dashboard
                                </NavLink>
                            </Authorized>
                        </AuthorizeView>

                        <!-- User Menu -->
                        <div class="relative">
                            <button @onclick="ToggleMenu"
                                    class="flex items-center gap-2 px-3 py-2 rounded-xl bg-primary-50 hover:bg-primary-100 transition-colors">
                                <div class="w-7 h-7 bg-primary-600 rounded-full flex items-center justify-center">
                                    <span class="text-white text-xs font-bold">@GetInitial()</span>
                                </div>
                                <span class="text-sm font-medium text-primary-700">@_userName</span>
                                <svg class="w-4 h-4 text-primary-500 transition-transform @(_menuOpen ? "rotate-180" : "")"
                                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>

                            @if (_menuOpen)
                            {
                                <div class="absolute right-0 mt-2 w-48 bg-white rounded-2xl shadow-xl border border-gray-100 py-2 z-50">
                                    <button @onclick="Logout"
                                            class="w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2">
                                        Logout
                                    </button>
                                </div>
                            }
                        </div>

                    </Authorized>

                    <NotAuthorized>
                        <a href="/login"
                           class="text-gray-600 hover:text-primary-600 font-medium text-sm transition-colors">
                            Log in
                        </a>
                        <a href="/register"
                           class="inline-flex items-center px-5 py-2 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-xl text-sm transition-colors shadow-sm">
                            Sign up
                        </a>
                    </NotAuthorized>
                </AuthorizeView>
            </div>

            <!-- Mobile Hamburger -->
            <button @onclick="ToggleMobileMenu"
                    class="md:hidden p-2 rounded-xl text-gray-500 hover:bg-gray-100 transition-colors">
                @if (_mobileMenuOpen)
                {
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                }
                else
                {
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                }
            </button>
        </div>

        <!-- Mobile Menu -->
        @if (_mobileMenuOpen)
        {
            <div class="md:hidden border-t border-gray-100 py-4 space-y-1">
                <a href="/" class="block px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-primary-50 hover:text-primary-600 rounded-xl">Home</a>
                <a href="/services" class="block px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-primary-50 hover:text-primary-600 rounded-xl">Services</a>

                <AuthorizeView>
                    <Authorized Context="authUserMobile">

                        <a href="/my-bookings"
                           class="block px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-primary-50 hover:text-primary-600 rounded-xl">
                            My Bookings
                        </a>

                        <AuthorizeView Roles="Admin">
                            <Authorized Context="adminUserMobile">
                                <a href="/admin/dashboard"
                                   class="block px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-primary-50 hover:text-primary-600 rounded-xl">
                                    Dashboard
                                </a>
                            </Authorized>
                        </AuthorizeView>

                        <button @onclick="Logout"
                                class="w-full text-left px-4 py-2.5 text-sm font-medium text-red-600 hover:bg-red-50 rounded-xl">
                            Logout
                        </button>

                    </Authorized>

                    <NotAuthorized>
                        <a href="/login"
                           class="block px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-primary-50 hover:text-primary-600 rounded-xl">
                            Log in
                        </a>
                        <a href="/register"
                           class="block mx-4 py-2.5 text-sm font-semibold text-white bg-primary-600 rounded-xl text-center">
                            Sign up
                        </a>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        }
    </div>
</nav>

@code {
    private bool _menuOpen = false;
    private bool _mobileMenuOpen = false;
    private string _userName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _userName = authState.User.FindFirst("name")?.Value
                    ?? authState.User.FindFirst("unique_name")?.Value
                    ?? "User";
    }

    private void ToggleMenu() => _menuOpen = !_menuOpen;
    private void ToggleMobileMenu() => _mobileMenuOpen = !_mobileMenuOpen;
    private string GetInitial() => _userName.Length > 0 ? _userName[0].ToString().ToUpper() : "U";

    private async Task Logout()
    {
        _menuOpen = false;
        await AuthService.LogoutAsync();
        Nav.NavigateTo("/", forceLoad: true);
    }
}