@page "/admin/dashboard"
@attribute [Authorize(Roles = "Admin")]
@inject IBookingService    BookingService
@inject IServiceApiService ServiceService

<PageTitle>Dashboard â€” Bookify Admin</PageTitle>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
        <p class="text-gray-400 mt-1">Overview of your Bookify platform</p>
    </div>

    @if (_loading)
    {
        <LoadingSpinner Message="Loading dashboard..." />
    }
    else
    {
        <!-- Stats -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-10">
            <StatsCard Icon="ðŸ“…" Label="Total Bookings"
                       Value="@_bookings.Count.ToString()" Color="blue" />
            <StatsCard Icon="â³" Label="Pending"
                       Value="@_bookings.Count(b => b.Status == "Pending").ToString()"
                       Color="yellow" Subtitle="Awaiting approval" />
            <StatsCard Icon="âœ…" Label="Approved"
                       Value="@_bookings.Count(b => b.Status == "Approved").ToString()"
                       Color="green" />
            <StatsCard Icon="ðŸ›Žï¸" Label="Active Services"
                       Value="@_serviceCount.ToString()" Color="blue" />
        </div>

        <!-- Recent Bookings -->
        <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden mb-8">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-50">
                <h2 class="font-semibold text-gray-900">Recent Bookings</h2>
                <a href="/admin/bookings"
                   class="text-sm text-primary-600 hover:text-primary-700 font-medium">
                    View all â†’
                </a>
            </div>

            @if (_bookings.Count == 0)
            {
                <div class="p-8">
                    <EmptyState Icon="ðŸ“­" Title="No bookings yet" Message="Bookings will appear here." />
                </div>
            }
            else
            {
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-100">
                            <tr>
                                @foreach (var h in new[] { "Service", "Client", "Date", "Status", "Actions" })
                                {
                                    <th class="text-left px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                        @h
                                    </th>
                                }
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50">
                            @foreach (var b in _bookings.OrderByDescending(x => x.Date).Take(10))
                            {
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 text-sm font-medium text-gray-900">@b.ServiceName</td>
                                    <td class="px-6 py-4 text-sm text-gray-500">@b.ClientName</td>
                                    <td class="px-6 py-4 text-sm text-gray-500 whitespace-nowrap">
                                        @b.Date.ToString("MMM dd, yyyy") at @b.Time.ToString(@"hh\:mm")
                                    </td>
                                    <td class="px-6 py-4"><StatusBadge Status="@b.Status" /></td>
                                    <td class="px-6 py-4">
                                        <div class="flex gap-2">
                                            @if (b.Status == "Pending")
                                            {
                                                <button @onclick="() => ApproveBooking(b.Id)"
                                                        class="px-2.5 py-1 text-xs font-medium text-green-700 bg-green-100 hover:bg-green-200 rounded-lg transition-colors">
                                                    Approve
                                                </button>
                                            }
                                            @if (b.Status == "Approved")
                                            {
                                                <button @onclick="() => CompleteBooking(b.Id)"
                                                        class="px-2.5 py-1 text-xs font-medium text-blue-700 bg-blue-100 hover:bg-blue-200 rounded-lg transition-colors">
                                                    Complete
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        <!-- Quick Links -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            @foreach (var link in _quickLinks)
            {
                <a href="@link.Href"
                   class="flex items-center gap-4 bg-white rounded-2xl border border-gray-100 p-5 hover:border-primary-200 hover:shadow-md transition-all group">
                    <div class="w-10 h-10 bg-primary-100 rounded-xl flex items-center justify-center text-xl group-hover:bg-primary-200 transition-colors">
                        @link.Icon
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900 text-sm">@link.Title</p>
                        <p class="text-xs text-gray-400 mt-0.5">@link.Sub</p>
                    </div>
                </a>
            }
        </div>
    }
</div>

@code {
    private List<BookingModel> _bookings     = [];
    private bool               _loading      = true;
    private int                _serviceCount = 0;

    private readonly (string Icon, string Title, string Sub, string Href)[] _quickLinks =
    [
        ("ðŸ“‹", "Manage Bookings",   "View & update all bookings",  "/admin/bookings"),
        ("ðŸ›Žï¸", "Manage Services",   "Add or edit services",        "/admin/services"),
        ("ðŸ—‚ï¸", "Manage Categories", "Organize service categories",  "/admin/categories"),
    ];

    protected override async Task OnInitializedAsync()
    {
        var bookTask  = BookingService.GetAllBookingsAsync();
        var svcTask   = ServiceService.GetAllAsync();
        _bookings     = await bookTask;
        var svcs      = await svcTask;
        _serviceCount = svcs.Count(s => !s.IsDeleted);
        _loading      = false;
    }

    private async Task ApproveBooking(Guid id)
    {
        if (await BookingService.ConfirmAsync(id))
            UpdateStatus(id, "Approved");
    }

    private async Task CompleteBooking(Guid id)
    {
        if (await BookingService.CompleteAsync(id))
            UpdateStatus(id, "Completed");
    }

    private void UpdateStatus(Guid id, string status)
    {
        var b = _bookings.FirstOrDefault(x => x.Id == id);
        if (b is not null) b.Status = status;
    }
}
